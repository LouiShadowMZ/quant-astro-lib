# -*- coding: utf-8 -*-
"""è°ƒç”¨.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1_UPPlNp2KK2RwKNAdMW8wVk05KkMsl35
"""

!pip install git+https://github.com/LouiShadowMZ/quant-astro-lib.git

import quant_astro as qa
import swisseph as swe
from quant_astro import create_dasha_table

# ----------------- è®¾ç½®æ‰€æœ‰å æ˜Ÿå‚æ•° -----------------
chart_name = {"matter_name": "æ¾³å¤§åˆ©äºšç•™å­¦å¥³æœ‹å‹"}

birth_config = {
    "local_time_str": "2026-02-12 20:51:37.000000", # æœ¬åœ°æ—¶é—´ï¼ˆå¿…é¡»å«ä¸¤ä½å°æ•°ç§’ï¼‰
    "timezone_str": "+8:00", # æ—¶åŒºï¼ˆæ”¯æŒ+8ã€-5:30ã€+5.5æ ¼å¼ï¼‰
    "latitude_str": "23Â°02â€²00.000000â€³", # çº¬åº¦ï¼ˆå¿…é¡»å¸¦ä¸¤ä½å°æ•°ç§’ï¼‰
    "longitude_str": "113Â°06â€²00.000000â€³", # ç»åº¦ï¼ˆå¿…é¡»å¸¦ä¸¤ä½å°æ•°ç§’ï¼‰
    "elevation": 0.0, # æµ·æ‹”ï¼ˆç±³ï¼Œä¸¤ä½å°æ•°ï¼‰
    "atpress": 1013.25, # å¤§æ°”å‹
    "attemp": 20.0, # æ°”æ¸©
}

calculation_options = {
    "ecliptic_mode": 'tropical', # é»„é“æ¨¡å¼ï¼štropical/sidereal
    "ayanamsha_mode": "SIDM_KRISHNAMURTI",
    # å²å·®ä½“ç³»ï¼ˆä»…æ’æ˜Ÿé»„é“ç”Ÿæ•ˆï¼‰SIDM_FAGAN_BRADLEY, SIDM_KRISHNAMURTI, SIDM_LAHIRI, SIDM_KRISHNAMURTI_VP291
    "node_mode": 'mean', # äº¤ç‚¹ç±»å‹ï¼štrue / mean
    "house_system": 'Regiomontanus', # å®«ä½åˆ¶ï¼š[Placidus|Koch|Regiomontanus|Whole Sign|Equal|Campanus]
    "USE_HELIOCENTRIC": True, # æ—¥å¿ƒåˆ¶

    # === è¡Œæ˜Ÿè¿‡æ»¤ ===
    # é€‰é¡¹ï¼š['Su', 'Mo', 'Me', 'Ve', 'Ma', 'Ju', 'Sa', 'Ur', 'Ne', 'Pl', 'Ra', 'Ke']ï¼Œè®¾ç½®ä¸º ['All'] ä»£è¡¨è®¡ç®—å…¨éƒ¨
    # è¿¦å‹’åº•ç§©åºï¼š ['Su', 'Mo', 'Ma', 'Me', 'Ju', 'Ve', 'Sa', 'Ra', 'Ke'],
    "selected_planets": ['Su', 'Mo', 'Me', 'Ve', 'Ma', 'Ju', 'Sa', 'Ra', 'Ke'],

    # kpåœå¦
    "KP_HORARY": {
    "is_active": False, # True / False æ˜¯å¦å¼€å¯
    "mode": "KS-N", # KS-N / CIL-N
    "number": 53 # "KS-N"å¯¹åº”1-249ä¹‹é—´æ•´æ•°ï¼Œ"1-2193"å¯¹åº”1-2193ä¹‹é—´æ•´æ•°
    }
}

# æ—¥å‡ºä¸å€¼æ—¥æ˜Ÿ
sunrise_config = {
    "rsmi": swe.CALC_RISE | swe.BIT_DISC_CENTER # ä¸è®¾ç½®å‚æ•°åˆ™é»˜è®¤ä¸ºä¸Šè¾¹ç¼˜
                # swe.BIT_DISC_CENTER : è®¡ç®—å¤ªé˜³ä¸­å¿ƒç‚¹
                # swe.BIT_DISC_BOTTOM : è®¡ç®—å¤ªé˜³ä¸‹è¾¹ç¼˜
                # swe.BIT_NO_REFRACTION : å…³é—­å¤§æ°”æŠ˜å°„ä¿®æ­£ï¼Œé»˜è®¤å¼€å¯
}

# è‡ªå®šä¹‰ç‚¹
custom_points_config = {
    "ç¦ç‚¹ (Part of Fortune)": 135.5,
    "æˆ‘çš„å¹¸è¿æ˜Ÿ": 246.8,
    "ä¸€ä¸ªç‰¹æ®Šä¸­ç‚¹": 310.12
}

# Dasha
dasa_config = {
    "max_level": 2,          # è®¡ç®—å±‚çº§ï¼š4ä»£è¡¨è®¡ç®—åˆ°ç¬¬å››å±‚
    "output_mode": "all",    # è¾“å‡ºæ¨¡å¼ï¼š"all"åŒ…å«æ‰€æœ‰å±‚çº§ï¼Œ"present"åªåŒ…å«å½“å‰æœ€å°å±‚çº§
    "days_in_year": 365.25   # Dashaè®¡ç®—ä¸­ä½¿ç”¨çš„å¹´é•¿åº¦
}

# ----------------- ç›¸ä½é…ç½® -----------------

# 2-1. ç›¸ä½æ¨¡å¼é€‰æ‹©
# å¯é€‰å€¼: 'orb' (å®¹è®¸åº¦), 'whole_sign' (æ•´å®«åˆ¶), 'vedic' (å°åº¦)
aspect_modes = ['orb']

# 2-2. åŸºç¡€å®¹è®¸åº¦é…ç½®
# æ ¼å¼: "è¡Œæ˜Ÿ:åº¦æ•°Â°åˆ†â€²ç§’â€³; ..."
orb_config_str = """
Su: 15Â°00â€²00â€³; Mo: 12Â°00â€²00â€³; Me: 7Â°00â€²00â€³; Ve: 7Â°00â€²00â€³;
Ma: 8Â°00â€²00â€³; Ju: 9Â°00â€²00â€³; Sa: 9Â°00â€²00â€³;
Ra: 0Â°00â€²00â€³; Ke: 0Â°00â€²00â€³;
Ur: 5Â°00â€²00â€³; Ne: 5Â°00â€²00â€³; Pl: 5Â°00â€²00â€³

# === çº¯æ•°å­—å®«ä½å®¹è®¸åº¦ ===
1: 5Â°00â€²00â€³;  10: 5Â°00â€²00â€³
"""

# 2-3. å®«ä½é€‰æ‹© (ä»…å®¹è®¸åº¦æ¨¡å¼ç”Ÿæ•ˆ)
# è¾“å…¥è¦å‚ä¸è®¡ç®—çš„å®«ä½æ•°å­—åˆ—è¡¨
active_houses_list = [1, 10]

# 2-4. è‡ªå®šä¹‰ç›¸ä½ç±»å‹
# æ ¼å¼: "è§’åº¦Â°ç¬¦å·"ï¼Œä»…å®¹è®¸åº¦æ¨¡å¼ç”Ÿæ•ˆ
custom_aspect_types = [
    "0Â°â˜Œ",       # åˆç›¸
    "60Â°âš¹",      # å…­åˆ†ç›¸
    "90Â°â–¡",      # åˆ‘ç›¸
    "120Â°â–³",     # æ‹±ç›¸
    "180Â°â˜",     # å†²ç›¸

]

# æ‰“åŒ…é…ç½®å­—å…¸
aspect_config = {
    'modes': aspect_modes,
    'orb_config_str': orb_config_str,
    'active_houses': active_houses_list,
    'aspect_types': custom_aspect_types
}

# ----------------- æ‰§è¡Œè®¡ç®— -----------------

# æ ¸å¿ƒè®¡ç®—ï¼šè¡Œæ˜Ÿå’Œå®«å¤´ä¿¡æ¯
planet_pos, house_pos, ascmc_tuple, jd, dignities = qa.calculate_positions(
    **birth_config,
    **calculation_options
)

# ----------------- å±æ€§è®¡ç®—ï¼šè·å–æ˜Ÿåº§ã€è½å®«ã€å®«ä¸»æ˜Ÿ -----------------
# è¿™æ˜¯ä¸€ä¸ªæ–°æ­¥éª¤ï¼Œè°ƒç”¨ attributes.py ä¸­çš„é€»è¾‘
planet_signs, house_signs, planet_houses, house_lords = qa.get_attributes(
    planet_pos,
    house_pos
)

# æ—¥å‡ºä¸å€¼æ—¥æ˜Ÿ
sunrise_results = qa.get_sun_rise_and_lord(birth_config, sunrise_config)

# ----------------- è¡Œæ˜Ÿæ—¶ -----------------
planetary_hour_data = qa.get_planetary_hour(birth_config, sunrise_config)

# KPè®¡ç®—
# 1. è·å–KPæ˜Ÿä¸»
kp_planet_results, kp_house_results = qa.get_kp_lords(planet_pos, house_pos)

# 2. è±¡å¾æ˜Ÿ
kp_planet_sigs, kp_house_sigs = qa.get_significators(planet_pos, house_pos, kp_planet_results, kp_house_results)

# 3. ä¸»å®°æ˜Ÿ
kp_ruling_planets = qa.get_ruling_planets(kp_planet_results, kp_house_results, sunrise_results['day_lord'])

# ç›¸ä½è®¡ç®—
aspect_results = qa.calculate_aspects(planet_pos, house_pos, aspect_config)

# ----------------- å‡†å¤‡æ•°æ® (æ–¹æ¡ˆä¸€ï¼šæ‰å¹³åŒ–å­—å…¸) -----------------
# ç›´æ¥æŠŠæ‰€æœ‰ä¿¡æ¯å†™åœ¨ä¸€ä¸ªå­—å…¸é‡Œï¼Œä¸è¦åµŒå¥—çš„å¤§æ‹¬å· {}
info_data = {
    # --- åŸºæœ¬ä¿¡æ¯ ---
    "äº‹é¡¹åç§°": chart_name.get("matter_name", "-"),

    # --- å‡ºç”Ÿå‚æ•° ---
    "æœ¬åœ°æ—¶é—´": birth_config.get("local_time_str", "-"),
    "æ—¶åŒº": birth_config.get("timezone_str", "-"),
    "çº¬åº¦": birth_config.get("latitude_str", "-"),
    "ç»åº¦": birth_config.get("longitude_str", "-"),
    # "æµ·æ‹”": birth_config.get("elevation", 0),
    # "å¤§æ°”å‹": birth_config.get("atpress", 0),
    # "æ¸©åº¦": birth_config.get("attemp", 0),

    # --- è®¡ç®—é€‰é¡¹ ---
    "é»„é“æ¨¡å¼": calculation_options.get("ecliptic_mode", "-"),

    # ã€æ’å…¥ç‚¹1ã€‘å¦‚æœä¸æ˜¯å›å½’é»„é“ï¼Œå°±åœ¨è¿™é‡Œæ’å…¥å²å·®ä½“ç³»
    **({"å²å·®ä½“ç³»": calculation_options.get("ayanamsha_mode", "-")}
       if calculation_options.get("ecliptic_mode") != 'tropical' else {}),

    "äº¤ç‚¹ç±»å‹": calculation_options.get("node_mode", "-"),
    "å®«ä½åˆ¶": calculation_options.get("house_system", "-"),
    "å¯ç”¨æ—¥å¿ƒåˆ¶": "æ˜¯" if calculation_options.get("USE_HELIOCENTRIC") else "å¦",

    # ã€æ’å…¥ç‚¹2ã€‘å¦‚æœKPå¼€å¯ï¼Œä»…æ’å…¥ KPæŠ¥æ•° (ä¸å†æ˜¾ç¤ºå¼€å…³çŠ¶æ€)
    **({"KPæŠ¥æ•°": calculation_options.get("KP_HORARY", {}).get("number", "-")}
       if calculation_options.get("KP_HORARY", {}).get("is_active") else {})
}


# ----------------- ç”Ÿæˆ HTML -----------------
output_file = "astro_chart_final.html"

# è°ƒç”¨å‡½æ•° (å‚æ•°ä¿æŒä¸å˜ï¼Œä½† chart_info ä¼ å…¥çš„æ˜¯ä¸Šé¢çš„ä¸­æ–‡ç‰ˆå­—å…¸)
qa.generate_chart_html(
    planet_pos,
    house_pos,
    chart_info=info_data, # ä¼ å…¥è¿™ä¸ªæ‰å¹³å­—å…¸
    kp_planet_results=kp_planet_results,
    kp_house_results=kp_house_results,
    kp_planet_sigs=kp_planet_sigs,
    kp_house_sigs=kp_house_sigs,
    kp_ruling_planets=kp_ruling_planets,

    # === æ–°å¢ä¼ å…¥ ===
    aspect_results=aspect_results,       # ä¼ å…¥è®¡ç®—å¥½çš„ç›¸ä½ç»“æœ
    aspect_config=aspect_config,         # ä¼ å…¥ç›¸ä½é…ç½® (å« active_houses)
    calculation_options=calculation_options, # ä¼ å…¥è®¡ç®—é…ç½® (å« selected_planets)
    # ================

    output_filename=output_file
)

# ä¸‹è½½éƒ¨åˆ†ä¿æŒä¸å˜...

# è‡ªåŠ¨è§¦å‘ä¸‹è½½ (Colabç¯å¢ƒ)
try:
    from google.colab import files
    print(f"âœ¨ HTML ç”Ÿæˆå®Œæ¯•ï¼Œæ­£åœ¨å¯åŠ¨ä¸‹è½½: {output_file}")
    files.download(output_file)
except ImportError:
    print(f"âœ… æ–‡ä»¶å·²ä¿å­˜è‡³æœ¬åœ°: {output_file}")

# ----------------- Dasaè®¡ç®— -----------------
# å°†ã€ç¬¬3æ­¥ã€‘è®¡ç®—å‡ºçš„ `planet_pos` å­—å…¸ä¼ å…¥å³å¯
print("\n--- å¼€å§‹ç”ŸæˆDashaæ—¶é—´è¡¨ ---")
create_dasha_table(planet_pos, birth_config, dasa_config)

# ----------------- æ£€æŸ¥æ‰€æœ‰åŸå§‹ç»“æœè¯å…¸ -----------------

print("\n" + "="*20 + " è¡Œæ˜ŸåŸå§‹ä½ç½®å­—å…¸ (planet_pos) " + "="*20)
for key, value in planet_pos.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å®«å¤´åŸå§‹ä½ç½®å­—å…¸ (house_pos) " + "="*20)
for key, value in house_pos.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å­—å…¸1ï¼šè¡Œæ˜Ÿçš„æ˜Ÿåº§å½’å± (planet_signs) " + "="*20)
for key, value in planet_signs.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å­—å…¸2ï¼šå®«ä½çš„æ˜Ÿåº§å½’å± (house_signs) " + "="*20)
for key, value in house_signs.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å­—å…¸3ï¼šè¡Œæ˜Ÿçš„å®«ä½å½’å± (planet_houses) " + "="*20)
for key, value in planet_houses.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å­—å…¸4ï¼šæ¯ä¸ªå®«ä½çš„ä¸»å®°æ˜Ÿ (house_lords) " + "="*20)
for key, value in house_lords.items():
    print(f"{key}: {value}")

print("="*20 + " KPè¡Œæ˜Ÿç»“æœå­—å…¸ (kp_planet_results) " + "="*20)
for key, value in kp_planet_results.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " KPå®«ä½ç»“æœå­—å…¸ (kp_house_results) " + "="*20)
for key, value in kp_house_results.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " è¡Œæ˜Ÿè±¡å¾å®«ä½ (kp_planet_sigs) " + "="*20)
for key, value in kp_planet_sigs.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " å®«ä½è±¡å¾æ˜Ÿ (kp_house_sigs) " + "="*20)
for key, value in kp_house_sigs.items():
    print(f"{key}: {value}")

print("\n" + "="*20 + " ä¸»å®°æ˜Ÿå­—å…¸ (kp_ruling_planets) " + "="*20)
print(kp_ruling_planets)

print("\n" + "="*20 + " è¡Œæ˜Ÿæ—¶æ•°æ® (Planetary Hour) " + "="*20)
for key, value in planetary_hour_data.items():
    print(f"{key}: {value}")

# === ã€æ–°å¢ã€‘æ‰“å°åº™æ—ºé™·è½è¡¨ ===
print("\n" + "="*20 + " è¡Œæ˜Ÿåº™æ—ºé™·è½é…ç½® (Dignities) " + "="*20)
for key, value in dignities.items():
    print(f"{key}: {value}")

# æ‰“å°ç›¸ä½è®¡ç®—çš„åŸå§‹ç»“æœå­—å…¸
print("\n" + "="*20 + " åŸå§‹ç›¸ä½æ•°æ® (aspect_results) " + "="*20)
print(f"aspect_results: {aspect_results}")

# å¦‚æœæ‚¨æƒ³çœ‹åˆ†é¡¹çš„åŸå§‹å­—å…¸ï¼š
if 'orb_mode' in aspect_results:
    print(f"\norb_mode_list: {aspect_results['orb_mode']}")

if 'whole_sign_mode' in aspect_results:
    print(f"\nwhole_sign_list: {aspect_results['whole_sign_mode']}")

if 'vedic_mode' in aspect_results:
    print(f"\nvedic_mode_list: {aspect_results['vedic_mode']}")


# æ—¥å‡ºä¸å€¼æ—¥æ˜Ÿå­—å…¸===
print("\n" + "="*20 + " å€¼æ—¥æ˜Ÿå­—å…¸ï¼ˆsunrise_resultsï¼‰ " + "="*20)
print("sunrise_results:", sunrise_results)

# æ‚¨ç”šè‡³å¯ä»¥æ£€æŸ¥å„’ç•¥æ—¥
print("\n" + "="*20 + " å„’ç•¥æ—¥ (Julian Day) " + "="*20)
print(jd)

# ----------------- æ‰§è¡Œå¹¶ç¾è§‚æ‰“å°ç›¸ä½ç»“æœ -----------------

print("\n" + "ğŸš€ ç›¸ä½è®¡ç®—ç»“æœ (Aspects Report)".center(60, "="))

# è¾…åŠ©å‡½æ•°ï¼šæ‰“å°åˆ†éš”çº¿
def print_separator(width=60):
    print("-" * width)

# 1. å®¹è®¸åº¦æ¨¡å¼è¾“å‡º
if 'orb_mode' in aspect_results and aspect_results['orb_mode']:
    count = len(aspect_results['orb_mode'])
    print(f"\n[ğŸ“¡ å®¹è®¸åº¦æ¨¡å¼ (Orb Mode)] - å…± {count} æ¡è®°å½•")
    print_separator(75)
    # å®šä¹‰è¡¨å¤´ï¼š<å·¦å¯¹é½, >å³å¯¹é½, ^å±…ä¸­
    # P1(5) P2(5) Sym(4) State(4) Angle(10) Orb(12) Definition(10)
    header = f"{'P1':<5} {'P2':<5} {'Sym':^5} {'St.':^5} {'Actual':>10} {'Orb':>12} {'Def':>10}"
    print(header)
    print_separator(75)

    for row in aspect_results['orb_mode']:
        p1 = row['p1']
        p2 = row['p2']
        sym = row['type']
        st = row['state']

        # ç²¾åº¦æ§åˆ¶
        actual = f"{row['actual_dist']:.4f}Â°" # å®é™…è§’åº¦
        orb_val = f"{row['orb']:.6f}Â°"        # å®¹è®¸åº¦è¯¯å·®
        defn = f"{row['angle_def']:.0f}Â°"     # å®šä¹‰è§’åº¦(å¦‚90)

        print(f"{p1:<5} {p2:<5} {sym:^5} {st:^5} {actual:>10} {orb_val:>12} {defn:>10}")

# 2. æ•´å®«åˆ¶æ¨¡å¼è¾“å‡º
if 'whole_sign_mode' in aspect_results and aspect_results['whole_sign_mode']:
    count = len(aspect_results['whole_sign_mode'])
    print(f"\n[ğŸ›ï¸ æ•´å®«åˆ¶æ¨¡å¼ (Whole Sign)] - å…± {count} æ¡è®°å½•")
    print_separator(40)
    print(f"{'Planet 1':<10} {'Aspect':^8} {'Planet 2':<10} {'State':<5}")
    print_separator(40)

    for row in aspect_results['whole_sign_mode']:
        # ç®€å•æ•´æ´çš„å¯¹é½
        print(f"{row['p1']:<10} {row['type']:^8} {row['p2']:<10} {row['state']}")

# 3. å°åº¦æ¨¡å¼è¾“å‡º
if 'vedic_mode' in aspect_results and aspect_results['vedic_mode']:
    count = len(aspect_results['vedic_mode'])
    print(f"\n[ğŸ•‰ï¸ å°åº¦æ¨¡å¼ (Vedic Mode)] - å…± {count} æ¡è§†çº¿")
    print_separator(50)
    print(f"{'Caster (æ–½)':<12} {'Type':^10} {'Receiver (å—)':<12}")
    print_separator(50)

    for row in aspect_results['vedic_mode']:
        # ç®­å¤´å¼è¡¨è¾¾ï¼Œæ¸…æ™°ç›´è§‚
        print(f"{row['p1']:<12} --{row['type']}-->   {row['p2']:<12}")

print("\n" + "="*60)